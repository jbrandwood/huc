/* isoLINK
 *
 * This program appends the IPL header together with
 * a list of binary segments which may be overlays or
 * data, and produces an ISO output file
 *
 */


/*************/
/* INCLUDES  */
/*************/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <sys/stat.h>
#include "main.h"
#include "../mkit/as/overlay.h"


/*************/
/* DEFINES   */
/*************/

#define OVERLAY_SUFFIX  "ovl"
#define MAX_FILES 255


/*************/
/* GLOBALS   */
/*************/

int sector_array[MAX_FILES + 1];
int file_count = 0;
int cderr_flag = 0;
int cderr_ovl = 0;
int pcfx_flag = 0;
int asm_flag = 1;
int sgx_flag = 0;
char prj_type[8];
char incpath[10][256];
int debug;

int ipl_flag = 0;
int ipl_load = 0x4000;
int ipl_exec = 0x4000;
int ipl_mpr2 = 0x00;
int ipl_mpr3 = 0x01;
int ipl_mpr4 = 0x02;
int ipl_mpr5 = 0x03;
int ipl_mpr6 = 0x04;
int ipl_mode = 0x60;
char * ipl_file = NULL;
char * ipl_name = "isoLINK";
char * ipl_nend;


/*************/
/* CODE      */
/*************/

void
zero_write(FILE *outfile, int sectors);

unsigned char *
prepare_ipl(unsigned char * dst)
{
   unsigned cmd;
   unsigned len;
   unsigned char * src;
   unsigned char * win;

   static unsigned char disc_header_pce [1047] = {
      0x71,0x36,0x28,0x1B,0x28,0x66,0x29,0xDC,0x29,0x27,0x29,0xE5,0x29,0x23,0x29,0x2A,
      0x28,0x66,0x38,0x32,0x27,0x46,0x26,0x0A,0x28,0x67,0x20,0x3E,0x24,0x04,0x23,0x45,
      0x24,0x7A,0xAA,0x29,0xC4,0x29,0xC2,0x29,0xF6,0x29,0x39,0x28,0x00,0x25,0x20,0x3D,
      0xE6,0x28,0x1F,0x28,0x6E,0x28,0x02,0x28,0x42,0x28,0x76,0x28,0x1D,0x2B,0xE8,0xC3,
      0x19,0xAA,0xC2,0x40,0x22,0x40,0x3F,0x3E,0xE5,0x50,0x17,0x28,0x67,0x3B,0xF9,0xF6,
      0x11,0x5A,0xBA,0x11,0xAA,0xB9,0x06,0xBA,0x70,0x21,0x66,0x25,0x3B,0x3C,0x60,0x28,
      0x63,0x28,0x4C,0x28,0x43,0x21,0x3C,0x23,0x68,0x28,0x62,0x28,0x07,0xAA,0x3F,0x0B,
      0x24,0x60,0x2B,0xEF,0x3F,0x0B,0x3A,0x11,0x2B,0xEF,0x39,0xF7,0x3D,0xDA,0x28,0x1D,
      0x28,0x43,0xA5,0x33,0x6C,0x28,0x67,0x72,0x32,0xAA,0x3C,0xEA,0xCE,0x79,0x02,0x42,
      0x21,0x7C,0x28,0x1C,0x28,0x4D,0x28,0x40,0x7C,0x72,0x2C,0xAA,0x55,0xFA,0xF8,0xE5,
      0xEE,0xFF,0xE9,0xEF,0xF8,0xAA,0x38,0x2C,0x3C,0xD1,0x3A,0xE6,0x22,0x40,0xAA,0xEE,
      0xE3,0xF8,0xEF,0xE9,0xFE,0xE5,0xF8,0xAA,0x3C,0x46,0x3B,0x58,0x25,0x35,0x27,0xE6,
      0xAA,0xE9,0xEE,0x87,0xF8,0xE5,0xE7,0x8A,0xF9,0xE3,0xE7,0xFF,0xE6,0xEB,0xE6,0x70,
      0x11,0xD1,0x3E,0x3D,0x3C,0xEC,0x3F,0xDC,0xAA,0xE8,0xE3,0xE5,0xF9,0x8A,0xE7,0xEB,
      0xE3,0xE4,0x8A,0xE9,0xE5,0xEE,0xEF,0x86,0x8A,0xD6,0x40,0xFA,0xE6,0xEB,0xF3,0xB1,
      0x73,0x01,0x25,0x06,0x3D,0x7B,0x26,0xC2,0x24,0x5D,0xDD,0x70,0x03,0xE9,0xE2,0xEF,
      0xE9,0xE1,0x8A,0xE7,0xE5,0xE4,0xE3,0xC1,0x60,0x86,0x8A,0xF9,0xF8,0xEB,0xE7,0xC9,
      0x30,0xE4,0xEB,0xED,0xD6,0x72,0x0F,0x3E,0x58,0x39,0xC9,0x23,0x41,0x27,0xED,0xAA,
      0xE8,0xEB,0xE9,0xE1,0xFF,0xFA,0x8A,0xE7,0xEF,0xE7,0xE5,0xF8,0xF3,0xAA,0x76,0x0A,
      0xFE,0xEF,0xE4,0xEB,0xE4,0xE9,0xEF,0xAA,0x21,0x4A,0x39,0xC9,0x27,0xEC,0x24,0xC3,
      0xAA,0xA0,0x77,0x22,0x8A,0xF9,0xFF,0xE8,0xAA,0x24,0xE5,0x25,0x49,0x2B,0xEA,0x39,
      0xE4,0xAA,0xFA,0xF9,0xED,0x8A,0xEE,0xF8,0xE3,0xFC,0xEF,0xF8,0xAA,0x20,0x48,0x3F,
      0x09,0x21,0xE7,0x27,0xE1,0xAA,0xED,0xF8,0xEB,0xFA,0xE2,0xE3,0xE9,0xE8,0x6A,0x27,
      0x42,0x26,0xF1,0x3A,0xF4,0xE8,0x04,0xB8,0x7A,0x15,0x21,0xD3,0x3A,0x46,0x27,0x24,
      0x3E,0xFC,0xAA,0x92,0xD2,0x92,0x8A,0xEB,0xE4,0xE1,0x8A,0xEC,0xE5,0xE4,0xFE,0xAA,
      0x25,0x16,0x23,0xF3,0x27,0xF5,0x8B,0x70,0x06,0xEE,0xEF,0xF9,0xE3,0xED,0xE4,0xAA,
      0x22,0x63,0x39,0x0B,0x3A,0xF4,0x24,0x55,0xFE,0xE3,0xFE,0xE6,0xEF,0xEA,0x73,0x0D,
      0x3F,0x3A,0x39,0xC9,0x3A,0xF4,0x3D,0x37,0xAA,0x9B,0x98,0xD2,0x9B,0x98,0x8A,0xE1,
      0xEB,0xE4,0xE0,0xE3,0xB6,0x40,0x20,0xDA,0x38,0xE0,0x58,0x1F,0x6E,0xE6,0x00,0x7F,
      0x01,0x24,0xF8,0x26,0x51,0x28,0x4A,0x28,0x6C,0xE6,0x00,0x7F,0x20,0x23,0x00,0x39,
      0xC9,0x24,0x5F,0x3F,0xDC,0xAA,0xE4,0xEF,0xE9,0x8A,0xE2,0xC5,0xC7,0xCF,0x8A,0xEF,
      0xC6,0xCF,0xC9,0xDE,0xC5,0xD8,0xC5,0xC4,0xC3,0xC9,0xD9,0xAA,0x3D,0x43,0x3C,0x72,
      0x27,0xEC,0x24,0x0B,0xE1,0x05,0x7F,0x01,0x3C,0xDB,0x3C,0x46,0x2B,0xEA,0x27,0xEC,
      0xE1,0x05,0x7F,0x01,0x23,0xDC,0x24,0xDB,0x3B,0x7D,0x25,0x04,0xC2,0x06,0x6F,0x46,
      0x27,0x48,0x32,0xCB,0x3F,0xC2,0x06,0x71,0x92,0x3A,0xFC,0x22,0x4E,0x27,0xED,0x25,
      0x10,0xAA,0x55,0x9B,0x93,0x92,0x92,0x8A,0xF9,0xCF,0xDA,0x84,0x8A,0xFD,0xD8,0xC3,
      0xDE,0xDE,0xCF,0xC4,0x8A,0xC8,0xD3,0x8A,0xFE,0xEB,0xE1,0xEB,0xE1,0xE3,0x8A,0xE1,
      0xE5,0xE8,0xEB,0xF3,0xEB,0xF9,0xE2,0xE3,0xAA,0x68,0x08,0xE0,0x03,0x8A,0x2F,0x50,
      0x03,0x9A,0x2F,0x51,0x03,0x1C,0x2F,0x56,0x03,0x75,0x2F,0x57,0x1B,0x50,0x7B,0x56,
      0x5A,0xAB,0xCA,0x62,0x60,0x7A,0x5F,0x07,0xA7,0x9A,0x7A,0xA8,0x03,0xCA,0x2F,0xAA,
      0x25,0xAA,0xA8,0x2A,0xDC,0x8A,0x33,0x4A,0x07,0xBB,0x9A,0x5A,0xAE,0x63,0x88,0x3A,
      0xA8,0x2A,0xB6,0xD9,0xA4,0x9A,0x56,0x8A,0xA9,0xAA,0xCE,0x55,0xCE,0x50,0x03,0x92,
      0x2F,0x51,0xCE,0x52,0x03,0xA8,0x2F,0x53,0x8A,0xA3,0x4A,0x63,0xAA,0x5A,0xA8,0x2A,
      0xD6,0x03,0xBA,0x27,0x88,0x88,0x27,0x8F,0x88,0x03,0xAA,0x27,0x8A,0x88,0x03,0x92,
      0x27,0x8B,0xF6,0x71,0x16,0x89,0x88,0x03,0x93,0x27,0x8E,0x88,0x03,0xA8,0x27,0xB5,
      0x88,0x07,0xBA,0x9A,0xB2,0xC3,0xAB,0x2F,0x54,0x07,0xA5,0x9A,0xC3,0xAA,0x2F,0x57,
      0x07,0xA4,0xF9,0x75,0x06,0x56,0x03,0x55,0x2F,0x55,0x03,0xAB,0x2F,0x52,0xCE,0x50,
      0xCE,0x51,0xB4,0x12,0x98,0xD5,0x1F,0xA8,0xD5,0x02,0x00,0x71,0x75,0x04,0x2F,0x52,
      0x07,0xB8,0x9A,0x2F,0x50,0x07,0xB9,0x9A,0x2F,0xCE,0x72,0x00,0xAD,0xAA,0xB5,0xAA,
      0xEE,0xD9,0xBE,0x61,0x70,0x02,0x07,0xBD,0x9A,0x5A,0x92,0x63,0x8B,0x1A,0x9E,0xAC,
      0x12,0x55,0xAA,0x10,0x99,0xDC,0x51,0x7A,0x8F,0x45,0xAA,0x88,0xF2,0x20,0xCE,0x52,
      0xDF,0x50,0xA0,0xA0,0xA0,0x7A,0xAE,0xB1,0x73,0x26,0x52,0x2F,0x53,0x07,0xB2,0x9A,
      0x2F,0x55,0x0F,0xAA,0x83,0x2A,0x2F,0x54,0x8A,0x96,0x4A,0x75,0xAA,0xAC,0xA5,0xAA,
      0xA9,0x8A,0x20,0x4A,0x03,0x55,0xF9,0xAB,0x03,0x52,0xF9,0xA8,0x07,0xA2,0x9A,0xB2,
      0xC7,0x5F,0x55,0xF9,0xAE,0x07,0xA3,0xF7,0x33,0xA2,0x07,0xA0,0xF7,0x33,0xBA,0x07,
      0xA1,0xF7,0x33,0x8A,0x07,0xA6,0xF7,0x71,0x17,0xEA,0xD9,0xAA,0x9A,0xAB,0x8A,0xA2,
      0xAA,0x0F,0xAE,0x7A,0xA5,0xB2,0x0F,0xAD,0xC3,0xAA,0x2F,0xAD,0x0F,0xA2,0xC3,0x9A,
      0x2F,0xA2,0x2A,0x99,0xD9,0xAB,0x8A,0x64,0x20,0x03,0xAB,0x94,0x10,0xAE,0x67,0x72,
      0x15,0x53,0x03,0x55,0x6F,0xAF,0x03,0x85,0x4F,0xAC,0x3A,0xA0,0xD9,0x6A,0x86,0x4A,
      0x75,0xBF,0xAA,0xE6,0x4A,0x75,0xD9,0xAF,0x8A,0x50,0x8A,0xA8,0xAA,0x2C,0x7F,0x03,
      0x7A,0xAC,0x08,0x55,0x30,0xC6,0xAD,0x8A,0xCA,0xAA,0xFF,0xEE,0x4A,0x03,0xF5,0x03,
      0xFA,0xE9,0x8A,0xEF,0xC4,0xCD,0xC3,0xC4,0xCF,0x8A,0xBD,0xF8,0xFB,0x17,0xF3,0xF9,
      0xFE,0xEF,0xE7,0xAA,0xE9,0xC5,0xDA,0xD3,0xD8,0xC3,0xCD,0xC2,0xDE,0x8A,0xE2,0xFF,
      0xEE,0xF9,0xE5,0xE4,0x8A,0xF9,0xE5,0xEC,0xFE,0x8A,0x85,0x8A,0x90,0xFA,0x83,0x91,
      0xFA,0x7F,0x00,0x86,0xE6,0xDE,0xCE,0x84,0xAA,0x8A,0xFF,0x03,0x1F,0xAA,0xFF,0xEE,
      0x7F,0x07,0x0F,0x00,0xEE,0x00,0x00
   };

   static unsigned char disc_header_pcfx [1607] = {
      0x7D,0x45,0xFA,0xE9,0x87,0xEC,0xF2,0x90,0xE2,0xDF,0xF5,0xE9,0xEE,0x87,0xF8,0xE5,
      0xE7,0x8A,0x28,0x1B,0x28,0x66,0x29,0xDC,0x29,0x27,0x29,0xE5,0x29,0x23,0x29,0x2A,
      0x28,0x66,0x38,0x32,0x27,0x46,0x26,0x0A,0x28,0x67,0x20,0x3E,0x24,0x04,0x23,0x45,
      0x24,0x7A,0x29,0xC4,0x29,0xC2,0x29,0xF6,0x29,0x39,0x28,0x00,0x25,0x20,0x3D,0xE6,
      0x28,0x1F,0x28,0x6E,0x28,0x02,0x28,0x42,0x28,0x76,0x28,0x1D,0x2B,0xE8,0xC4,0x40,
      0x22,0x40,0x3F,0x3E,0xE6,0x50,0x17,0x28,0x67,0x3B,0xF9,0xF6,0x1E,0x5A,0xBC,0x70,
      0x20,0x66,0x25,0x3B,0x3C,0x60,0x28,0x63,0x28,0x4C,0x28,0x43,0x21,0x3C,0x23,0x68,
      0x28,0x62,0x28,0x07,0x3F,0x0B,0x24,0x60,0x2B,0xEF,0x3F,0x0B,0x3A,0x11,0x2B,0xEF,
      0x39,0xF7,0x3D,0xDA,0x28,0x1D,0x28,0x43,0xA8,0x33,0x6C,0x28,0x67,0x76,0x22,0x3C,
      0xEA,0xD0,0x79,0x02,0x42,0x21,0x7C,0x28,0x1C,0x28,0x4D,0x28,0x40,0x80,0x1F,0xAA,
      0xFF,0x11,0x2B,0xAC,0xB2,0xF0,0x73,0x13,0xEF,0xDF,0xE0,0x1B,0xAA,0xBA,0xEF,0xDB,
      0xB2,0xDA,0xCA,0x16,0x8A,0xAA,0x6A,0x16,0xAB,0xAA,0x6C,0x0A,0x9A,0x2C,0xAA,0x06,
      0xE0,0xA8,0xF4,0x76,0x0A,0x76,0x2F,0xAA,0x06,0x94,0xA8,0x81,0xEA,0x8A,0x5E,0xAA,
      0xAC,0xAA,0x4E,0xAE,0xAC,0x8D,0xF6,0x45,0x8A,0x0A,0xF9,0xAA,0xF4,0x51,0xAA,0x46,
      0xAA,0xAC,0x8B,0xE6,0x20,0xA9,0x8A,0xFA,0x32,0xAE,0xA9,0x88,0xF4,0x71,0x05,0xEA,
      0x17,0xAB,0xAA,0xE0,0x0B,0x36,0x28,0x80,0x6E,0xAA,0xAA,0xEA,0x34,0x80,0x6E,0xA8,
      0xF8,0x14,0xAE,0xF8,0x12,0xAC,0xF8,0x12,0x87,0xAC,0x20,0x8A,0x16,0xEA,0x42,0x56,
      0xAE,0xAC,0x84,0xF2,0x70,0x01,0x6A,0x09,0xAA,0x8A,0x8A,0x0A,0xFF,0xFF,0xE0,0x60,
      0xAC,0x75,0xED,0x50,0x3F,0x6A,0xE2,0x50,0x6C,0x0A,0xA1,0xA6,0x4A,0x6A,0x73,0x09,
      0x4D,0x0A,0x71,0x28,0xAA,0x0B,0x9A,0xAA,0x8A,0x0B,0xFA,0xAA,0xAA,0x06,0x9E,0xAB,
      0xE4,0x23,0x2A,0xB2,0xE4,0x10,0x0E,0xE4,0x10,0xBA,0xE4,0x10,0xBA,0xE4,0x73,0x0B,
      0xB2,0xAB,0x2A,0x14,0xAB,0xAA,0x3E,0x08,0x1A,0x2F,0x0A,0x08,0x28,0xB2,0xAA,0x06,
      0x4A,0xAA,0xF0,0x10,0x14,0xF0,0x10,0x21,0xF0,0x14,0x7A,0xF0,0x10,0x7A,0xF0,0x10,
      0x32,0xF0,0x52,0x6A,0xAA,0x8A,0x0A,0xB9,0x2A,0x01,0x38,0x01,0x1C,0x22,0xBE,0xAA,
      0x72,0x70,0x01,0x15,0xAB,0xAA,0x74,0x09,0x3A,0x2F,0xEA,0xAA,0x13,0x94,0x32,0x72,
      0x03,0xAC,0x68,0xED,0xF5,0xEF,0x5E,0x3F,0x8A,0x0A,0xBF,0xDE,0x12,0x8B,0xD0,0xF3,
      0x0C,0x6A,0x09,0xBC,0xAA,0x8A,0x4E,0xAA,0xA9,0x8F,0xFE,0x8B,0x1E,0x55,0xAB,0x94,
      0xA6,0x5E,0x35,0x8A,0xEA,0xFE,0x31,0x0A,0xAA,0xAE,0x16,0x70,0x02,0xAA,0x02,0xAA,
      0xAA,0xCC,0xA8,0x68,0xEE,0x4A,0xB8,0x43,0x6A,0x15,0xAE,0xAA,0x06,0xC0,0x79,0xAD,
      0xD9,0x0C,0x84,0xFE,0x15,0x55,0x04,0x73,0x5B,0xC0,0x6F,0xAA,0xAA,0xE8,0xEF,0x61,
      0x1D,0xAA,0x55,0xC2,0xFB,0x62,0xFD,0xD4,0x9B,0x68,0xEB,0x2A,0xEB,0x02,0xEB,0x28,
      0xFB,0x8B,0xEA,0xA1,0x1E,0xAA,0x2A,0xAE,0x2E,0x8A,0xEA,0x2B,0x9B,0xCB,0xFB,0x15,
      0xEF,0x44,0x3F,0x2A,0x5F,0xAE,0xAC,0x75,0xEF,0x48,0x3F,0x55,0xEF,0x18,0x3F,0xB5,
      0xB2,0x75,0xA8,0x7E,0x6E,0xAA,0xAA,0x28,0xEC,0x6A,0xA6,0xB0,0x2E,0x6C,0x1E,0x55,
      0x55,0x4A,0xEA,0x45,0x05,0x84,0xD4,0x7F,0xAA,0x1F,0x0C,0xA8,0xAA,0x55,0x05,0x20,
      0x55,0x55,0x01,0x48,0x55,0x5C,0xA9,0xB5,0xB2,0x03,0xAB,0x88,0x10,0x6A,0x4E,0x43,
      0x6C,0x0E,0x8A,0xAA,0x8A,0x71,0x1B,0x6D,0x69,0xAA,0xAA,0x4B,0xEE,0xA8,0xE8,0xEA,
      0xE8,0x6A,0x0B,0x2A,0xAA,0x2A,0xE8,0x4E,0xEB,0x2E,0xF8,0x94,0xAA,0x8F,0xE8,0x84,
      0x9E,0xB4,0x2E,0xEA,0xA4,0xBE,0x3E,0xCD,0x68,0xE0,0x71,0x05,0xEB,0xEC,0x99,0x1C,
      0xA5,0xAA,0xCE,0xFC,0xAA,0x02,0xA0,0xAA,0xF6,0x71,0x27,0xEA,0xA8,0x6B,0xFF,0x3B,
      0x98,0x55,0xEF,0x7E,0x3F,0x2A,0x5C,0xAE,0xAC,0xB5,0xEC,0x62,0x3F,0x07,0x0F,0x5A,
      0x55,0x1E,0x3F,0x03,0xAB,0xB5,0xEF,0x30,0x3F,0xB5,0xB2,0xCC,0x67,0xAA,0xAA,0x6E,
      0xEE,0xE1,0x1F,0x55,0x55,0xDA,0xFF,0x8C,0x66,0xF4,0x71,0x13,0x6B,0xA9,0x9A,0xF6,
      0x88,0x22,0x80,0x5E,0xAA,0xAA,0x8B,0x1E,0xAA,0xAB,0xA0,0x3E,0x61,0x5D,0xAA,0xAA,
      0x55,0x01,0x4C,0x55,0x6C,0x65,0xE2,0x21,0x61,0x55,0xF2,0x73,0x23,0x72,0x55,0xB5,
      0xB2,0xAA,0xAA,0x22,0xAA,0x83,0x43,0x0D,0xF0,0x22,0x55,0x96,0xAE,0xBA,0xCC,0x8E,
      0xB2,0xE8,0x28,0x55,0x3E,0xAE,0xEA,0xBC,0x1F,0xAE,0xA3,0xBB,0x4F,0xC8,0xE8,0x22,
      0x4F,0xEB,0xEB,0xEE,0x4B,0xEB,0xEB,0xFD,0x01,0xEF,0x70,0x04,0x1F,0xAE,0xB3,0xBB,
      0x51,0x3E,0xAE,0xCA,0xBB,0xE8,0x28,0xD2,0x00,0xCC,0xD0,0xAA,0xA2,0x00,0xAC,0xBC,
      0x1D,0xFD,0x50,0xA3,0xCA,0x2C,0x20,0x88,0xF8,0x71,0x0B,0xA1,0xCA,0xAA,0x64,0x8A,
      0xA2,0xBB,0xAA,0xAA,0xAA,0xB5,0xAC,0xA0,0x88,0x56,0xAC,0xCB,0x8A,0xF5,0x61,0xAE,
      0x8A,0x44,0x52,0x68,0x2A,0xE0,0x70,0x03,0xB5,0x82,0x1A,0x22,0x52,0x1A,0xAA,0xBB,
      0x92,0x2C,0xF3,0x40,0x95,0xAC,0xA3,0xA5,0xF3,0x21,0x88,0x52,0xF3,0x70,0x23,0xAA,
      0xD5,0xAC,0xAA,0x58,0x22,0x55,0x1A,0xCA,0xBA,0x2C,0x52,0xAA,0x0A,0x33,0xAA,0xAA,
      0x55,0xAC,0x51,0x9A,0x65,0x45,0x58,0x2A,0xAA,0xAA,0x6A,0x38,0xAA,0xAA,0x55,0x92,
      0x84,0x86,0x55,0x45,0x45,0x2A,0xAA,0x33,0xAA,0xF3,0x50,0x52,0xA2,0xA0,0x55,0x55,
      0xF3,0x20,0x0A,0x55,0xF2,0x70,0x04,0x3A,0xAA,0xAB,0xCC,0x55,0x58,0xAA,0xA1,0x51,
      0x55,0x25,0xE4,0x01,0xEE,0x11,0xBA,0xEE,0x72,0x05,0x59,0xA2,0xA1,0x58,0x55,0xA4,
      0xAA,0xA2,0xAA,0x29,0xC3,0x33,0xF0,0x22,0x86,0xA4,0xE3,0x32,0x8A,0x2A,0x00,0xF1,
      0x40,0x55,0x84,0xAE,0x55,0xE2,0x41,0xAA,0x5A,0xAA,0x38,0xF0,0x71,0x25,0x5A,0x55,
      0xA6,0x82,0x51,0xAA,0xAA,0x03,0x00,0x56,0xAA,0xAA,0x38,0xAA,0xA9,0x82,0x55,0x1A,
      0x55,0xAA,0x1A,0x52,0xA2,0xAA,0xBB,0x94,0xA0,0xAA,0xBB,0xAA,0xA9,0xA2,0x55,0x8A,
      0x25,0xAA,0x41,0x76,0xBA,0xA2,0x33,0xA4,0xA0,0x88,0xD0,0x70,0x07,0xAA,0xAA,0x1A,
      0x25,0x76,0x3A,0xAC,0xAA,0xAC,0x3C,0xAA,0xAA,0x15,0x2A,0xA8,0x30,0x34,0xE8,0xAA,
      0x08,0x71,0x03,0xAB,0xEE,0x15,0xAB,0xA2,0xAA,0x88,0xB4,0xA2,0x8A,0xF4,0x70,0x03,
      0x56,0x2B,0xCA,0x8A,0xB5,0xAA,0xAA,0x33,0xAB,0x00,0xF3,0x30,0x52,0xAA,0xE8,0x0D,
      0x61,0xAA,0xBA,0xA9,0xAE,0x2A,0x88,0xF2,0xB0,0xAA,0x88,0x95,0x72,0xFC,0x30,0xA9,
      0x8A,0x2A,0xB1,0x00,0xF2,0x20,0xBB,0x95,0x73,0x71,0x27,0xAC,0x8C,0x6A,0x32,0xAB,
      0x22,0x52,0x8A,0xAC,0xBB,0xD5,0xAC,0xAA,0xAA,0xAA,0xAC,0xBE,0x69,0x3E,0x0C,0xA9,
      0xAE,0x52,0x3A,0xA3,0x33,0xD5,0xAA,0xAA,0xAA,0xAA,0x2C,0xE3,0xBB,0x6D,0xBE,0xAC,
      0xAA,0xAD,0xAC,0x22,0x72,0xCA,0x3A,0x55,0xA2,0xEE,0x72,0x07,0x23,0x33,0x65,0xBE,
      0xAC,0x38,0xAD,0xB2,0x22,0x73,0xEB,0x3A,0x22,0x55,0xDB,0x72,0x04,0x2B,0x33,0x66,
      0xBE,0x8A,0xA7,0xAC,0xAA,0xF5,0xA8,0x08,0x0E,0x10,0xA8,0xEE,0xF4,0x01,0x72,0x32,
      0xAE,0xA5,0xB2,0x8E,0x75,0xBC,0xDE,0xFE,0x12,0xA3,0xED,0x60,0x3A,0xB1,0x8C,0xB2,
      0x75,0x3E,0xB9,0x14,0x57,0xC8,0x72,0x01,0x1A,0xCA,0x88,0xB4,0xB2,0xAC,0x35,0x22,
      0xEE,0x72,0x07,0x8A,0xAA,0x2D,0xEB,0xCB,0x1A,0x28,0xBB,0x9D,0xAC,0x8E,0xCC,0x35,
      0xE8,0xED,0x72,0x1A,0x3A,0xAA,0x2D,0xE3,0xE8,0x4A,0xCB,0xAA,0x9D,0xB2,0x3A,0xEE,
      0x35,0xEB,0xAA,0xAA,0x51,0xAA,0xAA,0xC8,0xAA,0x2D,0xC3,0x2A,0x4A,0x23,0xBB,0xC7,
      0xAC,0xAC,0x22,0x35,0xC3,0xED,0x70,0x5C,0xC3,0xAA,0x29,0xA3,0xAA,0x4A,0xA8,0x33,
      0xC7,0xB2,0x8E,0xAA,0xB5,0xAC,0xAA,0xAA,0x59,0xAA,0x8A,0xAE,0x29,0xE3,0xAA,0x6A,
      0x8A,0x65,0xAC,0x32,0x8C,0xA5,0xAA,0xAA,0x49,0xAA,0x28,0xAA,0x29,0xE3,0xAA,0x2A,
      0x88,0x71,0x82,0xAC,0xBE,0xA5,0xA2,0xAA,0x69,0x8A,0xAA,0x29,0xAB,0x33,0xAA,0x70,
      0x32,0x8E,0x22,0xA5,0xA2,0x00,0x2D,0xC3,0xAA,0x2C,0xCB,0x88,0xAA,0xB4,0xB2,0x8C,
      0xA6,0x8C,0xAD,0xA2,0xAA,0x2C,0x28,0xBB,0xAA,0x94,0xAC,0xE3,0xBB,0xAE,0xAA,0xAD,
      0xAA,0xAA,0x66,0x3A,0xA2,0xAA,0x9C,0xAC,0x3E,0xAC,0x32,0xCA,0xA0,0x56,0x8A,0x81,
      0xFD,0x41,0xBE,0x23,0xAC,0x8E,0x9D,0xE0,0x52,0x80,0xAC,0x88,0xAA,0xAE,0xFB,0xFB,
      0xC0,0x54,0xC3,0xA2,0xAA,0x97,0xFD,0x51,0xA6,0x8C,0xA9,0xAE,0x56,0x3D,0xB0,0xAA,
      0xA6,0xBE,0xB0,0xFE,0x91,0xAA,0xC9,0xFD,0xE2,0xA6,0xBC,0xAA,0x4A,0x80,0x00,0x6E,
      0xFA,0x10,0xAB,0xFD,0x0F,0xFE,0x08,0x30,0xFA,0x28,0xF2,0xFE,0x21,0xF9,0x28,0xD6,
      0x74,0x06,0xEA,0x2B,0xCD,0x28,0xDE,0x28,0xC9,0x28,0xD8,0x28,0xC4,0x28,0xC7,0xEE,
      0x01,0xF4,0xC3,0xCF,0x28,0xD9,0x28,0x13,0xFA,0x10,0xAE,0x81,0x11,0xBF,0xE8,0x00,
      0xFC,0x10,0xFA,0xC1,0x35,0xCB,0xAA,0xAA,0x9C,0x20,0xAA,0xA8,0xFC,0x10,0xA9,0xFC,
      0x91,0xA2,0xE5,0xFC,0x00,0xFC,0x10,0xA5,0xEA,0x10,0xBA,0x58,0x10,0xB8,0xF4,0x50,
      0xBC,0xAA,0x22,0xBB,0x86,0xF8,0x10,0x9A,0xFC,0x10,0x9B,0xFC,0x10,0x8B,0xFC,0x30,
      0x89,0xAA,0x55,0xFF,0x45,0xAA,0xA9,0xAE,0xA9,0xBC,0x12,0x22,0xBC,0x10,0xAE,0xFC,
      0x11,0xAF,0x93,0x00,0xFC,0xB0,0xAD,0xAA,0xDC,0x9E,0xFD,0x30,0xEF,0x89,0xA3,0xE4,
      0x10,0xA7,0xF0,0x11,0xA4,0xA8,0x03,0xC8,0x0F,0xFF,0xA4,0x02,0x1E,0x11,0x8A,0xF7,
      0x13,0x2A,0xFC,0x7F,0x10,0xE2,0xFF,0xEE,0xAA,0xE8,0xDF,0xC3,0xC6,0xDE,0x8A,0xDD,
      0xC3,0xDE,0xC2,0x8A,0xC3,0xD9,0xC5,0xE6,0xC3,0xC4,0xC1,0x84,0xB0,0x17,0x12,0xAB,
      0xFB,0x7F,0x04,0xAB,0xAA,0x98,0x9A,0x98,0x98,0x9A,0x9B,0x98,0x9A,0xAA,0xFF,0xEE,
      0x7F,0x07,0x0F,0x00,0xEE,0x00,0x00
   };

   src = (pcfx_flag == 0) ? disc_header_pce : disc_header_pcfx;

   for (;;)
   {
      cmd = *src++;

      len = (cmd & 112) >> 4;
      if (len == 7) {
         len = *src++ + 7;
         if (len == 256) { len = src[0] + 256 * src[1]; src += 2; }
         else
         if (len == 257) { len = *src++ + 256; }
      }
      while (len--) *dst++ = 0xAAu ^ *src++;
      signed sOff = *src++ - 256;
      if (cmd & 128) {
         sOff  = (sOff ^ 65280) | (256 * *src++);
      }
      win = dst + sOff;
      len = (cmd & 15) + 3;
      if (len == 18) {
         len = *src++ + 18;
         if (len == 256) { len = src[0] + 256 * src[1]; src += 2; if (len == 0) break; }
         else
         if (len == 257) { len = *src++ + 256; }
      }
      while (len--) *dst++ = *win++;
   }

   return(dst);
}


void
init_path(void)
{
   const char *p, *pl;
   int i, l;

   strcpy(incpath[0], ".");
   strcat(incpath[0], DIR_SEPARATOR_STRING);

   p = getenv("PCE_INCLUDE");

   if (p == NULL) {
      p =
#ifdef WIN32
         "c:\\huc\\include\\huc"
#else
         "/usr/local/lib/huc/include/huc:" \
         "/usr/local/huc/include/huc:" \
         "/usr/local/share/huc/include/huc:" \
         "/usr/local/include/huc:" \
         "/usr/lib/huc/include/huc:" \
         "/usr/share/huc/include/huc:" \
         "/usr/include/huc"
#endif
      ;
   }

   for (i = 1; i < 10; i++) {
      pl = strchr(p, PATH_SEPARATOR);

      if (pl == NULL)
         l = strlen(p);
      else
         l = pl - p;

      if (l) {
         strncpy(incpath[i], p, l);
         p += l;
         while (*p == PATH_SEPARATOR)
            p++;
      }
      incpath[i][l] = '\0';

      if (l) {
         if (incpath[i][l - 1] != DIR_SEPARATOR)
            strcat(incpath[i], DIR_SEPARATOR_STRING);
      }
   }
}


FILE *
file_open(char *name, char *mode)
{
   FILE *fp = NULL;
   char testname[256];
   int i;

/* search current directory, then PCE_INCLUDE path */

   for (i = 0; i < 10; i++) {
      if (strlen(incpath[i])) {
         strcpy(testname, incpath[i]);
         strcat(testname, name);
         fp = fopen(testname, mode);
         if (fp != NULL) {
            if (debug) {
               printf("filename      = %s\n", testname);
            }
            break;
         }
      }
   }

   return(fp);
}


void
file_write(FILE *outfile, FILE *infile, char *filename, int curr_filenum)
{
   char buffer[2048];
   long size;
   int sectors;
   int bytes_read, bytes_written;
   int i, j;
   int code;
   int data_sector = -1;

   code = 0;
   if ((asm_flag == 0) &&
       (strcmp(OVERLAY_SUFFIX, &filename[strlen(filename) - 3]) == 0)) {
      code = 1;
   }

   /* check size of file */

   fseek(infile, 0L, SEEK_END);
   size = ftell(infile);
   rewind(infile);

   /* get proper number of sectors if not an exact size multiple */

   sectors = (size + 2047) / 2048;

   for (i = 0; i < sectors; i++) {
      bytes_read = fread((void *)buffer, 1, 2048, infile);

      if (bytes_read != 2048) {
         /* wrong place to get an incomplete read */

         if ( ((sectors * 2048) == size) || ((i + 1) != sectors) ) {
            printf("Error while reading file \"%s\"\n", filename);
            exit(1);
         } else {
            /* fill buffer with zeroes */
            memset(buffer + bytes_read, 0, 2048 - bytes_read);
         }
      }

      if (code == 1) {
         if (i == 0) {  /* ie. the file's boot segment */
            /* Confirm that this is really a HuC overlay */
            if (buffer[3] != 'H' || buffer[4] != 'u' || buffer[5] != 'C') {
               code = 0;
            } else {
               /* This byte is the place where the overlay entry point */
               /* declares "I am overlay number <n>", and now running  */

               buffer[0x07FF & (OVL_ENTRY_POINT + 1)] = curr_filenum;

               /* This byte is the place where the overlay declares */
               /* which bank to use to store the CD directory */

               data_sector = (8192 / 2048) * (int) buffer[(OVL_DATA_SECTOR & 0x07FF)];

               if ((cderr_flag == 1) && (curr_filenum == 1)) {
                  buffer[0x07FF & (CDERR_LENGTH + 0)] = sector_array[cderr_ovl+1] - sector_array[cderr_ovl];
                  buffer[0x07FF & (CDERR_SECTOR + 0)] = sector_array[cderr_ovl] & 255;
                  buffer[0x07FF & (CDERR_SECTOR + 2)] = sector_array[cderr_ovl] >> 8;
               }
            }
         } else if (i == data_sector)   {
            for (j = 0; j < 100; j++) {

               /* sector_array[0] is ipl.bin which is a segment    */
               /* but not an addressable one - still, it is stored */
               /* Encode this array into DATA_SEGMENT of all code  */
               /* overlays on disk, in Hu6280 addressable order    */

               buffer[j +   0] = (sector_array[j]) & 255;
               buffer[j + 100] = (sector_array[j]) >> 8;
            }
            buffer[  0] = 0;
            buffer[100] = 0;
         }
      }

      bytes_written = fwrite((void *)buffer, 1, 2048, outfile);

      if (bytes_written != 2048) {
         printf("Error writing output file while processing %s\n", filename);
         exit(1);
      }

      /* align to 4KB on the PC-FX to allow for 512Mbyte ISO */
      if ((pcfx_flag) && (sectors & 1)) {
         zero_write(outfile, 1);
      }
   }
}


#ifdef _WIN32
#include <sysinfoapi.h>

void
set_ipl_date(char * string)
{
   char temp[24];
   SYSTEMTIME t;
   GetSystemTime(&t);
   snprintf(temp, 23+1, "%4d%02d%02d", t.wYear, t.wMonth, t.wDay);
   temp[8] = '\0';
   strcpy(string, temp);
}
#else
#include <time.h>

void
set_ipl_date(char * string)
{
   char temp[24];
   time_t rawtime;
   time ( &rawtime );
   struct tm *timeinfo = gmtime ( &rawtime );
   strftime(temp, 23+1, "%Y%m%d", timeinfo);
   temp[8] = '\0';
   strcpy(string, temp);
}
#endif


void
ipl_write(FILE *outfile)
{
   int i;
   size_t sectors = sector_array[1] - sector_array[0];
   unsigned char * ipl_buffer = calloc(sectors, 2048);
   char use_ipl_scd = 0;

   /* custom SuperCD boot sector loader code made from "examples/asm/elmer/ipl-scd/" */
   static unsigned char ipl_scd [704] = {
      0x20,0x5A,0xE0,0xE0,0x03,0x90,0x59,0x20,0xDE,0xE0,0xB0,0x54,0x22,0x29,0x7F,0x22,
      0xE0,0x03,0x90,0x4C,0xA9,0x68,0x53,0x04,0xA0,0x01,0xB9,0x01,0x36,0x38,0xF9,0x00,
      0x36,0x85,0xF8,0x64,0xF9,0x43,0x04,0x85,0xFA,0x64,0xFB,0x62,0xCC,0x00,0x37,0x90,
      0x01,0x1A,0x85,0xFC,0xB9,0x00,0x37,0x85,0xFD,0xB9,0x00,0x36,0x85,0xFE,0xA9,0x06,
      0x85,0xFF,0x20,0x09,0xE0,0xC9,0x00,0xF0,0x06,0xA9,0x67,0xA2,0x31,0x80,0x1A,0x43,
      0x04,0x1A,0x53,0x08,0x1A,0x53,0x10,0x1A,0x53,0x20,0x1A,0x53,0x40,0x4C,0x00,0x40,
      0xAC,0xFF,0x35,0xD0,0xB5,0xA9,0x46,0xA2,0x31,0x48,0xDA,0x20,0x99,0xE0,0x20,0x7B,
      0xE0,0x20,0x84,0x31,0xA9,0x7D,0x85,0xEC,0xA9,0x32,0x85,0xED,0x20,0xC4,0x31,0x62,
      0xA2,0x20,0xA0,0x1C,0x20,0x6F,0xE0,0xA9,0x01,0x20,0x69,0xE0,0xA9,0x5D,0x8D,0x20,
      0x22,0xA9,0x32,0x8D,0x21,0x22,0xA9,0x01,0x8D,0x22,0x22,0x9C,0x23,0x22,0x9C,0x24,
      0x22,0x9C,0x25,0x22,0xA9,0x02,0x8D,0x1F,0x22,0xFA,0x68,0x20,0x1D,0x32,0x20,0x8A,
      0xE0,0x20,0x7B,0xE0,0x80,0xFE,0x01,0x0D,0x41,0x42,0x43,0x44,0x45,0x40,0x46,0x47,
      0x48,0x49,0x4A,0x4B,0x4C,0x40,0x41,0x4D,0x4E,0x4F,0x44,0x50,0x40,0x45,0x44,0x57,
      0x42,0x58,0x45,0x44,0x52,0x53,0x00,0x03,0x0D,0x46,0x47,0x40,0x44,0x45,0x45,0x54,
      0x45,0x53,0x40,0x46,0x55,0x51,0x51,0x54,0x4F,0x40,0x45,0x42,0x51,0x40,0x56,0x55,
      0x50,0x44,0x53,0x00,0x44,0x14,0xA2,0x1C,0xC2,0x13,0x00,0x23,0x00,0x23,0x00,0x23,
      0x00,0x23,0x00,0x88,0xD0,0xF5,0xCA,0xD0,0xF2,0x60,0xA9,0x05,0x85,0xF7,0x03,0x05,
      0x23,0x00,0xA9,0x00,0x85,0xF7,0x03,0x00,0x9C,0x02,0x02,0x9C,0x03,0x02,0xA9,0x02,
      0x85,0xF7,0x03,0x02,0xA2,0x08,0xC2,0x13,0x40,0x23,0x01,0x23,0x01,0x88,0xD0,0xF9,
      0xCA,0xD0,0xF6,0x60,0xA2,0x14,0xA9,0xFF,0x48,0xA9,0x00,0x85,0xF7,0x03,0x00,0x9C,
      0x02,0x02,0x8E,0x03,0x02,0xA9,0x02,0x85,0xF7,0x03,0x02,0xA9,0x19,0x85,0xF8,0xC2,
      0x82,0x9E,0x00,0x21,0xB1,0xEC,0x9D,0x01,0x21,0x0A,0x11,0xEC,0x9D,0x02,0x21,0x1D,
      0x00,0x21,0x5D,0x01,0x21,0x9D,0x00,0x21,0xC8,0xD0,0x02,0xE6,0xED,0xE8,0xE8,0xE0,
      0x10,0xD0,0xE1,0xE3,0x00,0x21,0x02,0x02,0x10,0x00,0x68,0xA2,0x08,0x8D,0x02,0x02,
      0x8D,0x03,0x02,0xCA,0xD0,0xFA,0x48,0xC6,0xF8,0xD0,0xC5,0x68,0x60,0x85,0xF8,0x86,
      0xF9,0xA0,0x01,0xB1,0xF8,0x4A,0xAA,0x62,0x6A,0x22,0x4A,0x22,0x6A,0x12,0xF8,0xC8,
      0x08,0x78,0x03,0x01,0x8D,0x02,0x02,0x8E,0x03,0x02,0x03,0x00,0x8D,0x02,0x02,0x8E,
      0x03,0x02,0x03,0x02,0xA9,0x02,0x85,0xF7,0x28,0xB1,0xF8,0xF0,0x0F,0xC8,0x18,0x69,
      0x00,0x8D,0x02,0x02,0x62,0x69,0x01,0x8D,0x03,0x02,0x80,0xED,0x60,0x00,0x00,0x00,
      0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
      0x00,0x00,0x00,0x00,0x00,0x02,0x00,0x4C,0x00,0x69,0x01,0xB2,0x01,0x00,0x00,0x00,
      0x00,0x00,0x00,0x00,0x00,0x3C,0x66,0x60,0x3C,0x06,0x66,0x3C,0x00,0x00,0x00,0x66,
      0x66,0x66,0x66,0x3E,0x00,0x00,0x00,0x7C,0x66,0x66,0x7C,0x60,0x60,0x00,0x00,0x3C,
      0x66,0x7E,0x60,0x3C,0x00,0x00,0x00,0x3C,0x66,0x60,0x60,0x60,0x00,0x3C,0x66,0x60,
      0x60,0x60,0x66,0x3C,0x00,0x7C,0x66,0x66,0x66,0x66,0x66,0x7C,0x00,0x00,0x00,0x00,
      0x7E,0x00,0x00,0x00,0x00,0x7C,0x66,0x66,0x7C,0x78,0x6C,0x66,0x00,0x3C,0x66,0x66,
      0x66,0x66,0x66,0x3C,0x00,0x63,0x77,0x7F,0x6B,0x6B,0x63,0x63,0x00,0x3E,0x03,0x1E,
      0x30,0x3F,0x00,0x00,0x00,0x00,0x00,0x66,0x66,0x66,0x3E,0x06,0x3C,0x00,0x00,0x3E,
      0x60,0x3C,0x06,0x7C,0x00,0x00,0x18,0x7E,0x18,0x18,0x18,0x0E,0x00,0x00,0x00,0x36,
      0x7F,0x6B,0x6B,0x63,0x00,0x00,0x00,0x3C,0x66,0x66,0x66,0x66,0x00,0x06,0x06,0x3E,
      0x66,0x66,0x66,0x3E,0x00,0x18,0x3C,0x3C,0x18,0x18,0x00,0x18,0x00,0x00,0x00,0x3C,
      0x66,0x66,0x66,0x3C,0x00,0x00,0x00,0x3C,0x06,0x3E,0x66,0x3E,0x00,0x00,0x00,0x3E,
      0x66,0x66,0x3E,0x06,0x3C,0x00,0x00,0x3E,0x66,0x66,0x3E,0x07,0x06,0x18,0x00,0x38,
      0x18,0x18,0x18,0x3C,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
   };

   /* initialize the CD's IPL sector contents */
   if (ipl_file != NULL) {
      /* read the IPL (and presumably boot code) from a file */
      FILE *infile = file_open(ipl_file, "rb");
      if (infile) {
         fread((void *)ipl_buffer, 1, 2048 * sectors, infile);
         fclose(infile);
      }

   } else {
      /* initialize the IPL */
      prepare_ipl(ipl_buffer);

      if (pcfx_flag) {
         /* Set boot parameters for PC-FX */

         /* 1st sector */
         ipl_buffer[0x820] = (sector_array[1] & 255);
         ipl_buffer[0x821] = (sector_array[1] >>  8) & 255;

         /* num sectors */
         ipl_buffer[0x824] = ((sector_array[2] - sector_array[1]) & 255);
         ipl_buffer[0x825] = ((sector_array[2] - sector_array[1]) >>  8) & 255;

         /* loading address */
         ipl_buffer[0x828] = (ipl_load & 255);
         ipl_buffer[0x829] = (ipl_load >>  8) & 255;
         ipl_buffer[0x82A] = (ipl_load >> 16) & 255;
         ipl_buffer[0x82B] = (ipl_load >> 24) & 255;

         /* starting address */
         ipl_buffer[0x82C] = (ipl_exec & 255);
         ipl_buffer[0x82D] = (ipl_exec >>  8) & 255;
         ipl_buffer[0x82E] = (ipl_exec >> 16) & 255;
         ipl_buffer[0x82F] = (ipl_exec >> 24) & 255;

      } else {
         /* Set boot parameters for PC Engine */

         /* Does the 1st file on the CD identify the project type? */
         if (prj_type[0] == 0x4C) {
            if (memcmp("HuC", prj_type + 3, 3) == 0) {
               /* HuC v4 with startup.asm changes from 2022 */
               use_ipl_scd = 0;
               asm_flag = 0;
            }
            else
            if (memcmp(" CD", prj_type + 3, 3) == 0) {
               /* HuCC or CORE asm-library CD */
               use_ipl_scd = 0;
            }
            else
            if (memcmp("SCD", prj_type + 3, 3) == 0) {
               /* HuCC or CORE asm-library SuperCD */
               use_ipl_scd = 1;
            }
            else
            if (memcmp("SGX", prj_type + 3, 3) == 0) {
               /* HuCC or CORE asm-library SuperGRAFX SuperCD */
               use_ipl_scd = 1;
               sgx_flag = 1;
            }
            else
            if (memcmp("SC1", prj_type + 3, 3) == 0) {
               /* HuCC or CORE asm-library SuperCD Stage1 loader */
               /* If use_ipl_scd then the kernel won't be loaded */
               /* when running on the wrong System Card! */
               use_ipl_scd = 0;
            }
            else
            if (memcmp("SG1", prj_type + 3, 3) == 0) {
               /* HuCC or CORE asm-library SuperGRAFX SuperCD Stage1 loader */
               /* If use_ipl_scd then the kernel won't be loaded */
               /* when running on the wrong System Card! */
               use_ipl_scd = 0;
               sgx_flag = 1;
            }
         }

         /* Use isoLINK's built-in IPL-SCD loader? */
         if (use_ipl_scd) {

            /* IPL-SCD loader code from the asm example project */
            memcpy(ipl_buffer + 0x890, ipl_scd, sizeof(ipl_scd));

            /* prg sector base */
            ipl_buffer[0x802] = 0;

            /* nb_sectors */
            ipl_buffer[0x803] = 0;

            /* loading address */
            ipl_buffer[0x804] = 0;
            ipl_buffer[0x805] = 0;

            /* starting address */
            ipl_buffer[0x806] = 0x3090 & 255;
            ipl_buffer[0x807] = 0;

            /* mpr registers */
            ipl_buffer[0x808] = 0;
            ipl_buffer[0x809] = 1;
            ipl_buffer[0x80A] = 2;
            ipl_buffer[0x80B] = 3;
            ipl_buffer[0x80C] = 4;

            /* load mode */
            ipl_buffer[0x80D] = 0;

         } else {

            /* prg sector base */
            ipl_buffer[0x802] = sector_array[1];

            /* nb_sectors */
            if (asm_flag) {
               /* ASM boot segment */
               ipl_buffer[0x803] = sector_array[2] - sector_array[1];
            } else {
               ipl_buffer[0x803] = 16;/* HuC boot segments; up to and including */
                                      /* overlay array.  The boot segments will load */
                                      /* the remaining segments and relocate code if */
                                      /* necessary           */
            }

            /* loading address */
            ipl_buffer[0x804] = (ipl_load & 255);
            ipl_buffer[0x805] = (ipl_load >> 8) & 255;

            /* starting address */
            ipl_buffer[0x806] = (ipl_exec & 255);
            ipl_buffer[0x807] = (ipl_exec >> 8) & 255;

            /* mpr registers */
            ipl_buffer[0x808] = ipl_mpr2;
            ipl_buffer[0x809] = ipl_mpr3;
            ipl_buffer[0x80A] = ipl_mpr4;
            ipl_buffer[0x80B] = ipl_mpr5;
            ipl_buffer[0x80C] = ipl_mpr6; /* HuC boot loader also @ $C000 */

            /* load mode */
            ipl_buffer[0x80D] = ipl_mode;
         }
      }
   }

   /* always write this project-specific data */
   if (pcfx_flag) {
      /* Set project-specific data for PC-FX */
      unsigned char beyond256mb = 255;

      /* allow game name to override the one in an ipl_file */
      if (ipl_flag || ipl_file == NULL) {
         memcpy(ipl_buffer + 0x800, ipl_name, ipl_nend - ipl_name);
      }

      /* current date (in UTC time) */
      set_ipl_date((char *) &ipl_buffer[0x878]);

      /* store directory information in the last 512 bytes of the 2nd sector */
      for (i = 0; i <= MAX_FILES; i++) {
         /* align to 4KB on the PC-FX to allow for 512Mbyte ISO */
         int lba = sector_array[i] / 2;

         /* sector_array[0] is ipl.bin which is a segment    */
         /* but not an addressable one - still, it is stored */
         ipl_buffer[2*i + 0xE00] = lba & 255;
         ipl_buffer[2*i + 0xE01] = lba >> 8;

         if ((beyond256mb == 255) && (lba >= 65536))
            beyond256mb = i;
      }

      /* store the count of directory entries */
      ipl_buffer[0xE00] = file_count;

      /* store which is the first file beyond the 256Mbyte ISO boundary */
      ipl_buffer[0xE01] = beyond256mb;

   } else {
      /* Set project-specific data for PC Engine */
      unsigned char beyond128mb = 255;

      /* allow game name to override the one in an ipl_file */
      if (ipl_flag || ipl_file == NULL) {
         memcpy(ipl_buffer + 0x86A, ipl_name, ipl_nend - ipl_name);
      }

      /* add a SuperGRAFX signature to the IPL Information Block */
      if (sgx_flag)
         memcpy(ipl_buffer + 0x880, "(for SuperGRAFX)", 16);

      /* store which is the cd error overlay file */
      ipl_buffer[0xDFF] = cderr_ovl;

      /* store directory information in the last 512 bytes of the 2nd sector */
      for (i = 0; i <= MAX_FILES; i++) {
         /* align to 2KB on the PC Engine to allow for 256Mbyte ISO */
         int lba = sector_array[i];

         /* sector_array[0] is ipl.bin which is a segment    */
         /* but not an addressable one - still, it is stored */
         ipl_buffer[i + 0xE00] = lba & 255;
         ipl_buffer[i + 0xF00] = lba >> 8;

         if ((beyond128mb == 255) && (lba >= 65536))
            beyond128mb = i;
      }

      /* store the count of directory entries */
      ipl_buffer[0xE00] = file_count;

      /* store which is the first file beyond the 128Mbyte ISO boundary */
      ipl_buffer[0xF00] = beyond128mb;
   }

   /* write out the ipl data */
   fwrite(ipl_buffer, 1, 2048 * sectors, outfile);

   if (ipl_buffer) free(ipl_buffer);
}


void
zero_write(FILE *outfile, int sectors)
{
   static char zero_buf[2048];
   int i;

   for (i = 0; i < sectors; i++) {
      fwrite(zero_buf, 1, 2048, outfile);
   }
}


void
usage(void)
{
   printf(ISOLINK_VERSION "\n");
   printf("\nUsage: isoLINK <outfile> [<options>] <infile_1> <infile_2> --cderr <infile_n>\n");
   printf("\nOptions:\n\n");
   printf("--pcfx  :  Write a PC-FX ISO instead of a PC Engine ISO\n\n");
   printf("--boot= :  The '=' is followed ... \n");
   printf("             <ipl-file> \n\n");
   printf("--ipl=  :  The '=' is followed by either ... \n");
   printf("             <program name> \n\n");
   printf("           ... or (only for PC Engine) ...\n");
   printf("             <program name>, \n");
   printf("             <load address>, \n");
   printf("             <exec address>, \n");
   printf("             <mpr2 value>, \n");
   printf("             <mpr3 value>, \n");
   printf("             <mpr4 value>, \n");
   printf("             <mpr5 value>, \n");
   printf("             <mpr6 value> \n\n");
   printf("           ... or (only for PC-FX) ...\n");
   printf("             <program name>, \n");
   printf("             <load address>, \n");
   printf("             <exec address> \n\n");
   printf("           HuC and HuCC programs can only set the <program name>!\n\n");
   printf("--sgx   :  Add a SuperGRAFX signature string to the IPL\n\n");
   printf("--cderr :  Indicates that the following overlay should be run instead\n");
   printf("           of displaying a text message when a SuperCD-ROM program is\n");
   printf("           executed on plain CD-ROM system.\n\n");
}


int
main(int argc, char *argv[])
{
   int i, file_num;
   int curr_sector, sectors, zero_fill;
   long file_len;
   char *inname;
   FILE *infile;
   FILE *outfile;

   debug = 0;
   file_count = 0;
   curr_sector = 0;
   file_num = 0;

   init_path();

   ipl_nend = ipl_name + strlen(ipl_name);

   /********************************************************/
   /* parse command-line                                   */
   /* if any sort of command-line options are found, abort */
   /*                                                      */
   /* otherwise, step through filenames testing them       */
   /* for existence, and creating an array which holds     */
   /* size and number of sectors                           */
   /********************************************************/
   if ((argc < 2) || (argv[1][0] == '-')) {
      usage();
      exit(1);
   }

   for (i = 2; i < argc; i++) {
      /* is this an option? */
      if (argv[i][0] == '-') {
         /* Convert GNU-style "--" options into "-" options for backwards-compatibility */
         if (argv[i][1] == '-') argv[i]++;

         if ((strcmp(argv[i], "-pcfx") == 0) &&
             (pcfx_flag == 0)) {       /* only valid once on line */

            if (file_num != 0 || ipl_flag != 0) {
               printf("\"--pcfx\" option must appear before \"--ipl\" and before any files!\n");
               printf("Operation aborted\n\n");
               exit(1);
            }

            pcfx_flag = 1;
            asm_flag = 1;              /* do not corrupt overlays */
            sgx_flag = 1;              /* mark option as invalid */
            cderr_flag = 1;            /* mark option as invalid */
            ipl_load = 0x8000;
            ipl_exec = 0x8000;
            continue;

         } else
         if ((strncmp(argv[i], "-boot=", 6) == 0) &&
             (ipl_file == NULL)) {        /* only valid once on line */

            ipl_file = argv[i] + 6;

            if (*ipl_file == '\0') {
               printf("\"--boot=\" option without a file name!\n");
               printf("Operation aborted\n\n");
               exit(1);
            }

            if (file_num != 0 || ipl_flag != 0) {
               printf("\"--boot\" option must appear before --ipl or any files!\n");
               printf("Operation aborted\n\n");
               exit(1);
            }

         } else
         if ((strncmp(argv[i], "-ipl=", 5) == 0) &&
             (ipl_flag == 0)) {        /* only valid once on line */

            long val;
            char * ptr = argv[i] + 5;
            char * nxt;

            if (*ptr == '\0') {
               printf("\"--ipl=\" option without any parameters!\n");
               printf("Operation aborted\n\n");
               exit(1);
            }

            if (file_num >= 2 || ipl_flag != 0) {
               printf("\"--ipl\" option must appear before any files!\n");
               printf("Operation aborted\n\n");
               exit(1);
            }

            nxt = strchr(ptr,',');

            /* Allow developers to set *only* the program name */
            if (nxt == NULL) {
               ipl_flag = 1;

               ipl_name = ptr;
               ipl_nend = ptr + strlen(ptr);

            } else {
               ipl_flag = -1;

               ipl_name = ptr;
               ipl_nend = nxt;
               ptr = nxt + 1;

               val = strtol(ptr, &nxt, 0);
               if (nxt != ptr) ipl_load = val;
               if (*nxt != ',') break;
               ptr = nxt + 1;

               val = strtol(ptr, &nxt, 0);
               if (nxt != ptr) ipl_exec = val;

               /* PC-FX does not have MPR settings! */
               if (pcfx_flag != 0) {
                  if (*nxt != '\0') break;
               } else {
                  if (*nxt != ',') break;
                  ptr = nxt + 1;

                  val = strtol(ptr, &nxt, 0);
                  if (nxt != ptr) ipl_mpr2 = val;
                  if (*nxt != ',') break;
                  ptr = nxt + 1;

                  val = strtol(ptr, &nxt, 0);
                  if (nxt != ptr) ipl_mpr3 = val;
                  if (*nxt != ',') break;
                  ptr = nxt + 1;

                  val = strtol(ptr, &nxt, 0);
                  if (nxt != ptr) ipl_mpr4 = val;
                  if (*nxt != ',') break;
                  ptr = nxt + 1;

                  val = strtol(ptr, &nxt, 0);
                  if (nxt != ptr) ipl_mpr5 = val;
                  if (*nxt != ',') break;
                  ptr = nxt + 1;

                  val = strtol(ptr, &nxt, 0);
                  if (nxt != ptr) ipl_mpr6 = val;
                  if (*nxt != '\0') break;
               }

               ipl_flag = 1;
            }
            continue;

         } else
         if ((strcmp(argv[i], "-cderr") == 0) &&
             (cderr_flag == 0)) {       /* only valid once on line */

            if (file_num < 2) {
               printf("\"--cderr\" cannot be first file!\n");
               printf("Operation aborted\n\n");
               exit(1);
            }

            if (i >= (argc - 1)) {
               printf("\"--cderr\" must be followed by a filename!\n");
               printf("Operation aborted\n\n");
               exit(1);
            }

            cderr_flag = 1;
            cderr_ovl = file_num;
            continue;

         } else
         if ((strcmp(argv[i], "-asm") == 0)) {
            /* ignore this now that HuC programs are identified by signature */
            continue;

         } else
         if ((strcmp(argv[i], "-sgx") == 0) &&
             (sgx_flag == 0)) {        /* only valid once on line */
            sgx_flag = 1;
            continue;

         } else {
            usage();
            exit(1);
         }
      }

      /* is the custom name too long? */
      if ((ipl_nend - ipl_name) > (pcfx_flag ? 32 : 22)) {
         printf("\"--ipl=\" name must be 22 characters or less for PCE, 32 or less for PC-FX!\n");
         printf("Operation aborted\n\n");
         exit(1);
      }

      /* is the directory full? */
      if (file_num == MAX_FILES) {
         printf("Too many files on the CD!\nThe maximum is %d.\n", MAX_FILES);
         printf("Operation aborted\n\n");
         exit(1);
      }

      inname = argv[i];

      if (file_num == 0) {
         if (ipl_file != NULL) {
            inname = ipl_file;
         } else {
            sector_array[file_num++] = curr_sector;
            curr_sector += 2;
         }
      }

      infile = file_open(inname, "rb");

      if (infile == NULL) {
         printf("Could not open file: \"%s\"\n", inname);
         printf("Operation aborted\n\n");
         exit(1);
      }

      if (file_num == 1) {
         /* read the 1st file's header for identification */
         if (fread((void *)prj_type, 1, 8, infile) != 8) {
            printf("Error while reading file \"%s\"\n", inname);
            exit(1);
         }
      }

      fseek(infile, 0L, SEEK_END);
      file_len = ftell(infile);
      rewind(infile);
      fclose(infile);

      sectors = (file_len + 2047) / 2048;

      /* align to 4KB on the PC-FX to allow for 512Mbyte ISO */
      if ((pcfx_flag) && (sectors & 1))
         ++sectors;

      if (debug) {
         printf("length = %ld\n", file_len);
         printf("start sector  = %d\n", curr_sector);
         printf("len (sectors) = %d\n", sectors);
      }

      sector_array[file_num++] = curr_sector;
      curr_sector += sectors;
   }

   if (ipl_flag < 0) {
      printf("Malformed --ipl option: \"%s\"\n", argv[i]);
      printf("Operation aborted\n\n");
      exit(1);
   }

   file_count = file_num;

   /* fill in the rest of the directory */
   while (file_num <= MAX_FILES) sector_array[file_num++] = curr_sector;

   /* OK, let's open them for real now   */
   /* and copy them from input to output */

   outfile = fopen(argv[1], "wb");

   ipl_write(outfile);

   file_num = 0;
   for (i = 2; i < argc; i++) {
      if (argv[i][0] != '-') {
         file_num++;
         infile = file_open(argv[i], "rb");
         file_write(outfile, infile, argv[i], file_num);
         fclose(infile);
      }
   }

   /* pad it out to 6 seconds to comply */
   /* with CDROM specification */

   zero_fill = (6 * 75) - curr_sector;

   /* pad at least 2 seconds of trailing zeroes */

   if (zero_fill < (2 * 75))
      zero_fill = 2 * 75;

   zero_write(outfile, zero_fill);

   fclose(outfile);

   return(0);
}
